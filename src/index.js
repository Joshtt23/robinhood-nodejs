import { authenticate, submitChallenge } from "./auth.js";
import RobinhoodApi from "./api.js";

// ‚úÖ Export `submitChallenge` explicitly
export { submitChallenge };

export default async function Robinhood(credentials) {
  try {
    let authResponse;

    if (credentials.token) {
      console.log("‚úÖ Using provided token...");
      authResponse = { tokenData: { access_token: credentials.token } };
    } else {
      // ‚úÖ Start authentication
      authResponse = await authenticate(credentials);

      if (authResponse.status === "awaiting_input") {
        let authType = "unknown";

        if (authResponse.message.includes("SMS") || authResponse.message.includes("Authenticator")) {
          authType = "mfa";
        } else if (authResponse.message.includes("Confirm device approval")) {
          authType = "device_confirmation";
        }

        return {
          status: "awaiting_input",
          workflow_id: authResponse.workflow_id,
          message: authResponse.message,
          authType, // ‚úÖ Now includes what type of authentication is needed
        };
      }

      if (
        authResponse.status !== "success" ||
        !authResponse.tokenData.access_token
      ) {
        throw new Error("‚ùå Authentication failed: Unexpected response");
      }

      console.log("‚úÖ Authentication successful!");
    }

    // ‚úÖ Always ensure API instance is included
    const apiInstance = new RobinhoodApi(authResponse.tokenData.access_token);

    return {
      tokenData: authResponse.tokenData,
      api: apiInstance,
    };
  } catch (error) {
    console.error("üö® Robinhood Error:", error);
    throw error;
  }
}
